import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.net.URI;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.security.MessageDigest;
import java.util.Base64;

public class PresignFlow {

    public record PresignUploadResponse(
            String preSignedUrl,
            String generatedId,
            String fileVersionId,
            int step2Status,
            String step2ResponseBody,
            int uploadStatus,
            String uploadResponseBody
    ) {}

    /**
     * Step 2: POST {ws_url}/file?autoUploadDuplicateFile=true&contentMD5=...&fileLength=...&fileName=...
     * Step 3: PUT to S3 presigned URL with Content-MD5 (DO NOT send Content-Type if SignedHeaders=content-md5;host)
     */
    public static PresignUploadResponse getPresignedUrlAndUpload(
            URI presignApiBaseUri,          // e.g. https://host/.../file   (base without query)
            String bearerToken,             // token (with or without "Bearer ")
            Path file,
            String fileNameForServer,
            boolean autoUploadDuplicateFile,
            boolean sendContentTypeOnPut,   // set FALSE for your screenshot (SignedHeaders=content-md5;host)
            String contentType              // only used if sendContentTypeOnPut=true
    ) throws Exception {

        HttpClient client = HttpClient.newHttpClient();
        ObjectMapper om = new ObjectMapper();

        // --- Read file bytes once ---
        byte[] bytes = Files.readAllBytes(file);
        long fileLength = bytes.length;

        // --- base64(MD5(fileBytes)) ---
        String contentMd5Base64 = Base64.getEncoder().encodeToString(
                MessageDigest.getInstance("MD5").digest(bytes)
        );

        // --- Step 2 URL query params (matches your Postman: autoUploadDuplicateFile + contentMD5) ---
        String q = "autoUploadDuplicateFile=" + autoUploadDuplicateFile
                + "&contentMD5=" + URLEncoder.encode(contentMd5Base64, StandardCharsets.UTF_8)
                + "&fileLength=" + fileLength
                + "&fileName=" + URLEncoder.encode(fileNameForServer, StandardCharsets.UTF_8);

        URI presignUri = URI.create(presignApiBaseUri.toString()
                + (presignApiBaseUri.toString().contains("?") ? "&" : "?")
                + q);

        // --- Authorization header ---
        String auth = bearerToken == null ? "" : bearerToken.trim();
        if (!auth.toLowerCase().startsWith("bearer ")) {
            auth = "Bearer " + auth;
        }

        // --- Step 2 call (Postman shows POST) ---
        HttpRequest presignReq = HttpRequest.newBuilder()
                .uri(presignUri)
                .header("Authorization", auth)
                .header("Accept", "application/json")
                .POST(HttpRequest.BodyPublishers.noBody())
                .build();

        HttpResponse<String> presignResp = client.send(presignReq, HttpResponse.BodyHandlers.ofString());
        int step2Status = presignResp.statusCode();
        String step2Body = presignResp.body();

        if (step2Status < 200 || step2Status >= 300) {
            throw new RuntimeException("Presign API failed: " + step2Status + " body=" + step2Body);
        }

        // --- Parse Step 2 response ---
        JsonNode root = om.readTree(step2Body);

        String generatedId = asString(root.get("generatedId"));

        // IMPORTANT: your response has data array with multiple objects,
        // e.g. one object contains preSignedURL, another contains fileVersionId.
        String preSignedUrl = null;
        String fileVersionId = null;

        JsonNode dataNode = root.path("data");
        if (dataNode.isArray()) {
            for (JsonNode item : dataNode) {
                if (preSignedUrl == null) {
                    preSignedUrl = firstNonBlank(item,
                            "preSignedURL", "preSignedUrl", "presignedUrl");
                }
                if (fileVersionId == null) {
                    fileVersionId = firstNonBlank(item,
                            "fileVersionId", "fileVersionID");
                }
            }
        }

        // Fallbacks (if API ever changes)
        if (preSignedUrl == null) preSignedUrl = firstNonBlank(root, "preSignedURL", "preSignedUrl", "presignedUrl");
        if (fileVersionId == null) fileVersionId = firstNonBlank(root, "fileVersionId", "fileVersionID");

        if (generatedId == null || generatedId.isBlank()) {
            throw new RuntimeException("Could not find generatedId in response JSON: " + step2Body);
        }
        if (preSignedUrl == null || preSignedUrl.isBlank()) {
            throw new RuntimeException("Could not find preSignedURL in response JSON: " + step2Body);
        }
        if (fileVersionId == null || fileVersionId.isBlank()) {
            throw new RuntimeException("Could not find fileVersionId in response JSON: " + step2Body);
        }

        // --- Step 3: PUT upload to S3 presigned URL ---
        HttpRequest.Builder putBuilder = HttpRequest.newBuilder()
                .uri(URI.create(preSignedUrl))
                .header("Content-MD5", contentMd5Base64.trim())
                .PUT(HttpRequest.BodyPublishers.ofByteArray(bytes));

        // For your screenshot SignedHeaders=content-md5;host, keep this FALSE:
        if (sendContentTypeOnPut && contentType != null && !contentType.isBlank()) {
            putBuilder.header("Content-Type", contentType);
        }

        HttpResponse<String> putResp = client.send(putBuilder.build(), HttpResponse.BodyHandlers.ofString());
        int uploadStatus = putResp.statusCode();
        String uploadBody = putResp.body();

        // S3 presigned PUT success is usually 200 or 204
        if (uploadStatus != 200 && uploadStatus != 204) {
            throw new RuntimeException("Upload failed: " + uploadStatus + " body=" + uploadBody);
        }

        return new PresignUploadResponse(
                preSignedUrl,
                generatedId,
                fileVersionId,
                step2Status,
                step2Body,
                uploadStatus,
                uploadBody
        );
    }

    private static String firstNonBlank(JsonNode node, String... keys) {
        for (String k : keys) {
            JsonNode v = node.get(k);
            String s = asString(v);
            if (s != null && !s.isBlank()) return s;
        }
        return null;
    }

    private static String asString(JsonNode node) {
        if (node == null || node.isNull()) return null;
        return node.asText(); // handles numeric nodes too
    }
}