import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.web.reactive.function.client.ExchangeFilterFunction;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.util.DefaultUriBuilderFactory;
import reactor.core.publisher.Mono;

import java.net.URI;
import java.nio.file.Files;
import java.nio.file.Path;

public class S3Put {

    private final WebClient client;

    public S3Put() {
        DefaultUriBuilderFactory f = new DefaultUriBuilderFactory();
        f.setEncodingMode(DefaultUriBuilderFactory.EncodingMode.NONE);

        this.client = WebClient.builder()
                .uriBuilderFactory(f)
                // Log the ACTUAL request URL + headers WebClient will send
                .filter(ExchangeFilterFunction.ofRequestProcessor(req -> {
                    System.out.println("=== ACTUAL REQUEST ===");
                    System.out.println(req.method() + " " + req.url());
                    req.headers().forEach((k, v) -> System.out.println(k + ": " + v));
                    return Mono.just(req);
                }))
                .build();
    }

    public void uploadUrl(String presignedUrl, Path file, String contentMd5, String contentType) throws Exception {
        HttpClient client = HttpClient.newHttpClient();
        HttpRequest httpRequest = HttpRequest.newBuilder()
                .uri(URI.create(presignedUrl))
                .header(HttpHeaders.CONTENT_TYPE, contentType)
                .header("Content-MD5", contentMd5.trim())
                .PUT(HttpRequest.BodyPublishers.ofFile(file))
                .build();

        log.info("Sending request to {}, {} ",presignedUrl, contentMd5.trim());
        log.info("Request Header Map {} ",httpRequest.headers().map());

        HttpResponse<String> response = client.send(httpRequest, HttpResponse.BodyHandlers.ofString());
        if(response.statusCode() == 200) {
            System.out.println("Upload Success");
        }else{
            System.out.println("Upload Failed "+response.statusCode());
            System.out.println("Error "+ response.body());

        }
    }
    public void uploadUrl(String presignedUrl, Path file, String contentMd5, String contentType) throws Exception {
        HttpClient client = HttpClient.newHttpClient();
        HttpRequest httpRequest = HttpRequest.newBuilder()
                .uri(URI.create(presignedUrl))
                .header(HttpHeaders.CONTENT_TYPE, contentType)
                .header("Content-MD5", contentMd5.trim())
                .PUT(HttpRequest.BodyPublishers.ofFile(file))
                .build();

        log.info("Sending request to {}, {} ",presignedUrl, contentMd5.trim());
        log.info("Request Header Map {} ",httpRequest.headers().map());

        HttpResponse<String> response = client.send(httpRequest, HttpResponse.BodyHandlers.ofString());
        if(response.statusCode() == 200) {
            System.out.println("Upload Success");
        }else{
            System.out.println("Upload Failed "+response.statusCode());
            System.out.println("Error "+ response.body());

        }
    }


    public Mono<Void> putPresigned(String presignedUrl, Path file, String base64Md5) {
        URI uri = URI.create(presignedUrl);

        return Mono.fromCallable(() -> Files.readAllBytes(file))
                .flatMap(bytes -> client.put()
                        .uri(uri)  // IMPORTANT: use as-is
                        // IMPORTANT: host is in SignedHeaders, so set it explicitly
                        .header(HttpHeaders.HOST, uri.getHost())
                        // IMPORTANT: send exactly one Content-MD5 header
                        .header("Content-MD5", base64Md5)
                        .header(HttpHeaders.CONTENT_LENGTH, String.valueOf(bytes.length))
                        .contentType(MediaType.APPLICATION_OCTET_STREAM) // safe (not signed)
                        .bodyValue(bytes)
                        .retrieve()
                        .toBodilessEntity()
                        .then()
                );
    }
}
