package com.example.flow.service;

import com.example.flow.client.ApiClient;
import com.example.flow.dto.*;
import com.example.flow.util.ApiAssert;
import com.example.flow.util.ApiFlowException;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

@Service
public class FlowOrchestratorService {

  private final AuthTokenService auth;
  private final ApiClient api;
@Value("${api.step6.message-status-path}") private String step6Path;

@Value("${api.step5.post-path}") private String step5PostPath;

@Value("${flow.step5.partner-id}") private Long step5PartnerId;
@Value("${flow.step5.entity-type:INVOICE}") private String step5EntityType;
@Value("${flow.step5.action-type:UPLOAD}") private String step5ActionType;
@Value("${flow.step5.generic-format:true}") private boolean step5GenericFormat;

  @Value("${api.base-url}") private String apiBaseUrl;

  @Value("${api.step2.presign-path}") private String step2Path;
  @Value("${api.step4.status-path}") private String step4Path;
  @Value("${api.step5.convert-path}") private String step5Path;
  @Value("${api.step6.message-status-path}") private String step6Path;

  @Value("${flow.success-message-type:SUCCESS}") private String successMessageType;

  @Value("${flow.poll.max-attempts:30}") private int pollMaxAttempts;
  @Value("${flow.poll.sleep-ms:2000}") private long pollSleepMs;

  private static final MediaType XLSX =
      MediaType.parseMediaType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

  public FlowOrchestratorService(AuthTokenService auth, ApiClient api) {
    this.auth = auth;
    this.api = api;
  }

  public FlowResult runAll(byte[] xlsxBytes, String originalFileName) {

    // ================= Step 1: Auth token =================
      TokenResponse token = auth.getTokenStrict();
      String accessToken = token.accessToken;

    // ================= Step 2: Get presigned URL =================
    // EDIT: PresignRequest fields to match your API exactly
// ================= Step 2: Upload/init (your screenshot) =================
var step2Url = apiBaseUrl + step2Path;

ResponseEntity<Step2UploadInitResponse> step2 = api.postBytesExpectJson(
    step2Url,
    accessToken,
    xlsxBytes,
    MediaType.parseMediaType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"),
    Step2UploadInitResponse.class
);

ApiAssert.require200(step2.getStatusCodeValue(), "Step2");
Step2UploadInitResponse step2Body = step2.getBody();
ApiAssert.requireNotNull(step2Body, "Step2", "response body");
ApiAssert.requireMessageTypeSuccess(step2Body.messageType, successMessageType, "Step2");

// required outputs
ApiAssert.requireNotNull(step2Body.generatedId, "Step2", "generatedId");

String presignedUrl = com.example.flow.util.Step2DataExtractor.extractPresignedUrl(step2Body.data);
Long fileVersionId  = com.example.flow.util.Step2DataExtractor.extractFileVersionId(step2Body.data);

// Your flow says Step3 needs presignedUrl. If your API sometimes returns blank,
// we still validate presence because Step3 can’t run without it.
ApiAssert.requireNotBlank(presignedUrl, "Step2", "data.preSignedURL");
ApiAssert.requireNotNull(fileVersionId, "Step2", "data.fileVersionId");

// carry forward:
String generatedId = String.valueOf(step2Body.generatedId);

    // ================= Step 3: Upload file to presigned URL =================
     ResponseEntity<Void> step3 = api.putBytesToPresigned(presignedUrl, xlsxBytes,
    MediaType.parseMediaType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
);

ApiAssert.require200(step3.getStatusCodeValue(), "Step3");

// ================= Step 4: Upload status check (PUT, no body) =================
String step4Url = apiBaseUrl + com.example.flow.util.UrlTemplate.fill(step4Path, generatedId, fileVersionId);

ResponseEntity<com.example.flow.dto.Step4StatusResponse> step4 =
    api.putNoBodyExpectJson(step4Url, accessToken, com.example.flow.dto.Step4StatusResponse.class);

com.example.flow.util.ApiAssert.require200(step4.getStatusCodeValue(), "Step4");
var step4Body = step4.getBody();

com.example.flow.util.ApiAssert.requireNotNull(step4Body, "Step4", "response body");
com.example.flow.util.ApiAssert.requireMessageTypeSuccess(step4Body.messageType, successMessageType, "Step4");

// ================= Step 5: POST (returns PENDING + message UUID) =================

// Choose a filename to send:
// - If Step2 returned newFileName in data array, use it
// - Otherwise fall back to the original filename
String newFileName = com.example.flow.util.Step2DataExtractor.extractNewFileName(step2Body.data);
String fileNameForStep5 = (newFileName != null) ? newFileName : originalFileName;

com.example.flow.util.ApiAssert.requireNotBlank(fileNameForStep5, "Step5", "fileName");

Long partnerId = step5PartnerId; // injected from properties (shown below)

com.example.flow.dto.Step5PostRequest req = new com.example.flow.dto.Step5PostRequest();
req.actionType = step5ActionType; // "UPLOAD"
req.entityType = step5EntityType; // "INVOICE"
req.requests = java.util.List.of(
    new com.example.flow.dto.Step5PostRequest.Item(
        step5GenericFormat,   // true
        fileVersionId,        // from Step2
        partnerId,
        fileNameForStep5
    )
);

var step5 = api.postJson(
    apiBaseUrl + step5PostPath,
    accessToken,
    req,
    com.example.flow.dto.Step5PostResponse.class
);

com.example.flow.util.ApiAssert.require200(step5.getStatusCodeValue(), "Step5");

var step5Body = step5.getBody();
com.example.flow.util.ApiAssert.requireNotNull(step5Body, "Step5", "response body");

// ✅ Step5 can be PENDING or SUCCESS (your screenshot is PENDING)
com.example.flow.util.ApiAssert.requireMessageTypeIn(step5Body.messageType, "Step5", "PENDING", "SUCCESS");

// Step6 needs Step5 response.message
com.example.flow.util.ApiAssert.requireNotBlank(step5Body.message, "Step5", "response.message");
String messageForStep6 = step5Body.message;




    // ================= Step 6: Poll for message status =================
// Step6 uses UUID from Step5 response.message
var step6Final = pollStep6(accessToken, messageForStep6);

// Enforce final requirement
com.example.flow.util.ApiAssert.requireMessageTypeSuccess(step6Final.messageType, successMessageType, "Step6");
if (step6Final.data != null && !step6Final.data.isEmpty()
    && step6Final.data.get(0).statusCountMap != null
    && step6Final.data.get(0).statusCountMap.getOrDefault("ERROR", 0) > 0) {
  throw new com.example.flow.util.ApiFlowException("Step6 SUCCESS but ERROR count > 0");
}

    MessageStatusResponse finalMsg = pollMessageStatus(accessToken, messageForStep6);

    FlowResult out = new FlowResult();
    out.generatedId = generatedId;
    out.fileVersionId = fileVersionId;
    out.step5Message = messageForStep6;
    out.finalMessageType = finalMsg.messageType;
    out.finalMessage = finalMsg.message;
    return out;
  }

private com.example.flow.dto.Step6PollResponse pollStep6(String accessToken, String messageKey) {
  for (int attempt = 1; attempt <= pollMaxAttempts; attempt++) {

    String step6Url = apiBaseUrl
        + com.example.flow.util.UrlTemplate.fillMessage(step6Path, java.net.URLEncoder.encode(messageKey, java.nio.charset.StandardCharsets.UTF_8));

    var resp = api.getJson(step6Url, accessToken, com.example.flow.dto.Step6PollResponse.class);

    com.example.flow.util.ApiAssert.require200(resp.getStatusCodeValue(), "Step6 (attempt " + attempt + ")");
    var body = resp.getBody();
    com.example.flow.util.ApiAssert.requireNotNull(body, "Step6", "response body");

    // ✅ stop only when messageType == SUCCESS
    if (body.messageType != null && body.messageType.trim().equalsIgnoreCase(successMessageType)) {
      return body;
    }

    // Optional early fail if API ever returns FAILURE
    if (body.messageType != null && body.messageType.trim().equalsIgnoreCase("FAILURE")) {
      throw new com.example.flow.util.ApiFlowException("Step6 failed: messageType=FAILURE message=" + body.message);
    }

    sleep(pollSleepMs);
  }

  throw new com.example.flow.util.ApiFlowException("Step6 timeout: did not reach messageType=" + successMessageType);
}

  private MessageStatusResponse pollMessageStatus(String accessToken, String messageKey) {
    for (int attempt = 1; attempt <= pollMaxAttempts; attempt++) {

      // If your Step6 endpoint is GET ?message=...
      String url = apiBaseUrl + step6Path + "?message=" + enc(messageKey);

      ResponseEntity<MessageStatusResponse> step6 = api.getJson(url, accessToken, MessageStatusResponse.class);
      ApiAssert.require200(step6.getStatusCodeValue(), "Step6 (attempt " + attempt + ")");

      MessageStatusResponse body = step6.getBody();
      if (body == null) throw new ApiFlowException("Step6 failed: null body (attempt " + attempt + ")");

      // Your requirement: messageType must be success
      if (body.messageType != null && body.messageType.trim().equalsIgnoreCase(successMessageType)) {
        return body;
      }

      // If API ever returns an explicit failure messageType, stop early
      if (body.messageType != null && body.messageType.trim().equalsIgnoreCase("FAILURE")) {
        throw new ApiFlowException("Step6 failed: messageType=FAILURE message=" + body.message);
      }

      sleep(pollSleepMs);
    }

    throw new ApiFlowException("Step6 timeout: did not reach messageType=" + successMessageType);
  }

  private static void sleep(long ms) {
    try { Thread.sleep(ms); }
    catch (InterruptedException e) {
      Thread.currentThread().interrupt();
      throw new ApiFlowException("Polling interrupted", e);
    }
  }

  private static String enc(String s) {
    return URLEncoder.encode(s, StandardCharsets.UTF_8);
  }

  private static String keepNameOrDefault(String name) {
    if (name == null || name.isBlank()) return "upload.xlsx";
    return name;
  }
}
