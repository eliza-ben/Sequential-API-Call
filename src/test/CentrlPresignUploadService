public class CentrlPresignUploadService {

    private final HttpClient httpClient;
    private final ObjectMapper objectMapper;

    public CentrlPresignUploadService(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
        this.httpClient = HttpClient.newHttpClient();
    }

    /**
     * Step 1: POST {ws_url}/file?autoUploadDuplicateFile=true&contentMD5=...&fileLength=...&fileName=...
     * Step 2: PUT to S3 presigned URL with Content-MD5
     */
    public PresignedUploadResult presignAndUpload(
            URI presignApiBaseUri,
            String bearerToken,
            Path file,
            String fileNameForServer,
            boolean autoUploadDuplicateFile,
            boolean sendContentTypeOnPut,
            String contentType
    ) throws Exception {

        // Reading the bytes and length from the file path
        byte[] bytes = Files.readAllBytes(file);
        long fileLength = bytes.length;

        // content Md5 fgr the file
        String contentMd5Base64 = Base64.getEncoder().encodeToString(
                MessageDigest.getInstance("MD5").digest(bytes)
        );
        log.info("fileLength {} contentMd5B {}", fileLength, contentMd5Base64);

        // Appending the queryParam, Doing it this way to avoid double encoding. and creating the Final Url
        String q = "autoUploadDuplicateFile=" + autoUploadDuplicateFile
                + "&contentMD5=" + URLEncoder.encode(contentMd5Base64, StandardCharsets.UTF_8)
                + "&fileLength=" + fileLength
                + "&fileName=" + URLEncoder.encode(fileNameForServer, StandardCharsets.UTF_8);

        URI presignUri = URI.create(presignApiBaseUri.toString()
                + (presignApiBaseUri.toString().contains("?") ? "&" : "?")
                + q);
        log.info("Step 1 Url {}", presignUri.toString());


        // Step 1 : Post to get the Presigned Url
        HttpRequest presignReq = HttpRequest.newBuilder()
                .uri(presignUri)
                .header("Authorization", "Bearer " + bearerToken.trim())
                .header("Accept", "application/json")
                .POST(HttpRequest.BodyPublishers.noBody())
                .build();

        HttpResponse<String> presignResp = httpClient.send(presignReq, HttpResponse.BodyHandlers.ofString());
        int step2Status = presignResp.statusCode();
        String step2Body = presignResp.body();

        if (step2Status < 200 || step2Status >= 300) {
            throw new RuntimeException("Presign API failed: " + step2Status + " body=" + step2Body);
        }

        // Parsing the Step 1 response to get the presigned Url and fileversionId
        ParsedPresign parsed = parsePresign(step2Body);
        log.info("Successful retrieval of  presigned Url {}, fileVersionId {}, fileId {}", parsed.preSignedUrl(), parsed.fileVersionId(), parsed.generatedId);

        // Step 2 uploading the file to S3 with the presigned url
        HttpRequest.Builder putBuilder = HttpRequest.newBuilder()
                .uri(URI.create(parsed.preSignedUrl))
                .header("Content-MD5", contentMd5Base64.trim())
                .PUT(HttpRequest.BodyPublishers.ofByteArray(bytes));

        if (sendContentTypeOnPut && contentType != null && !contentType.isBlank()) {
            putBuilder.header("Content-Type", contentType);
        }

        HttpResponse<String> putResp = httpClient.send(putBuilder.build(), HttpResponse.BodyHandlers.ofString());
        int uploadStatus = putResp.statusCode();
        String uploadBody = putResp.body();

        if (uploadStatus != 200 && uploadStatus != 204) {
            throw new RuntimeException("Upload failed: " + uploadStatus + " body=" + uploadBody);
        }
        log.info("Successful Uploading of File to S3");

        return new PresignedUploadResult(
                parsed.preSignedUrl,
                parsed.fileVersionId,
                null,
                parsed.generatedId

        );
    }


    private record ParsedPresign(String preSignedUrl, String generatedId, String fileVersionId) {
    }

    private ParsedPresign parsePresign(String step2Body) throws Exception {
        JsonNode root = objectMapper.readTree(step2Body);

        String generatedId = asString(root.get("generatedId"));

        String preSignedUrl = null;
        String fileVersionId = null;

        JsonNode dataNode = root.path("data");
        if (dataNode.isArray()) {
            for (JsonNode item : dataNode) {
                if (preSignedUrl == null) {
                    preSignedUrl = firstNonBlank(item, "preSignedURL", "preSignedUrl", "presignedUrl");
                }
                if (fileVersionId == null) {
                    fileVersionId = firstNonBlank(item, "fileVersionId", "fileVersionID");
                }
            }
        }

        if (preSignedUrl == null) preSignedUrl = firstNonBlank(root, "preSignedURL", "preSignedUrl", "presignedUrl");
        if (fileVersionId == null) fileVersionId = firstNonBlank(root, "fileVersionId", "fileVersionID");

        if (generatedId == null || generatedId.isBlank()) {
            throw new RuntimeException("Could not find generatedId in response JSON: " + step2Body);
        }
        if (preSignedUrl == null || preSignedUrl.isBlank()) {
            throw new RuntimeException("Could not find preSignedURL in response JSON: " + step2Body);
        }
        if (fileVersionId == null || fileVersionId.isBlank()) {
            throw new RuntimeException("Could not find fileVersionId in response JSON: " + step2Body);
        }

        return new ParsedPresign(preSignedUrl, generatedId, fileVersionId);
    }

    private static String firstNonBlank(JsonNode node, String... keys) {
        for (String k : keys) {
            String s = asString(node.get(k));
            if (s != null && !s.isBlank()) return s;
        }
        return null;
    }

    private static String asString(JsonNode node) {
        if (node == null || node.isNull()) return null;
        return node.asText();
    }
}
